function reply(id) {
    document.getElementById("input-comment-new-parent-comment").value = id;

    var replyForm = document.getElementById("form-comment-new");

    try {
        replyForm.removeChild(document.getElementById("section-comment-reply-preview"));
    } catch (e) {

    }

    var replyTo = document.getElementById("article-comment-" + id).cloneNode(true);

    replyTo.id = "article-comment-reply-to";

    var repliesToDelete = replyTo.getElementsByClassName("section-comment-replies")[0];
    if (repliesToDelete) {
        replyTo.removeChild(repliesToDelete);
    }
    replyTo.firstElementChild.firstElementChild.removeChild(replyTo.getElementsByClassName("a-comment-reply")[0]);

    var section = document.createElement("section");
    section.id = "section-comment-reply-preview";
    section.appendChild(document.createTextNode("В ответ на: "));
    section.appendChild(replyTo);

    var clearButton = document.createElement("a");
    clearButton.id = "a-comment-new-clear";
    clearButton.href = location.pathname + "#form-comment-new";
    clearButton.onclick = function () {
        commentClearReplyTo();
        return false;
    };
    clearButton.appendChild(document.createTextNode("Очистить"));

    section.appendChild(clearButton);

    replyForm.insertBefore(section, document.getElementById("textarea-comment-new"));

    location.hash = "";
    location.hash = "#form-comment-new";
}

function commentClearReplyTo() {
    document.getElementById("input-comment-new-parent-comment").value = null;

    var replyForm = document.getElementById("form-comment-new");

    try {
        replyForm.removeChild(document.getElementById("section-comment-reply-preview"));
    } catch (e) {
    }
}

function sendComment(url) {
    var xhr = new XMLHttpRequest();
    xhr.open('POST', url, true);
    xhr.onreadystatechange = function () {
        if (xhr.readyState == 4) {
            if (xhr.status == 200) {
                /*
                var response = JSON.parse(xhr.responseText);
                document.getElementById("section-comments").innerHTML = response.data;
                location.hash = "";
                location.hash = "#article-comment-" + response.id;*/
            }
        }
    };
    //xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
    var formData = new FormData(document.forms.newcomment);
    new_comment = true;
    xhr.send(formData);
}

function subscribe_to_new_answers() {
    var $info = $('#div-comments-cent-data');
    var centrifuge = new Centrifuge({
        url: $info.data('cent-url'),
        user: $info.data('cent-user').toString(),
        timestamp: $info.data('cent-ts').toString(),
        info: $info.data('cent-info'),
        token: $info.data('cent-token'),
        debug: false,
    });

    var channel = $info.data('cent-channel');
    console.log('subscribe on channel ' + channel);
    centrifuge.subscribe(channel, function (msg) {
        console.log(msg);

        var p = null;

        if ("parent_comment" in msg.data){
            var pc = $("#article-comment-" + msg.data.parent_comment.toString());
            var sec = pc.has(".section-comment-replies");
            if (jQuery.isEmptyObject(sec) || sec.length == 0){
                pc.append('<section class="section-comment-replies"></section>');
                sec = pc.children(".section-comment-replies");
            }
            p = sec;
        } else {
            p = $("#form-comment-new");
        }

        var cmt =
            '<article id="article-comment-'+ msg.data.id.toString() +'" class="article-comment">' +
                '<header>' +
                    '<p><strong>От: '+ msg.data.author +'</strong><a class="a-comment-reply" href="?parent_comment='+ msg.data.id.toString() +'#form-comment-new" onclick="reply('+ msg.data.id.toString() +'); return false;">Ответить</a></p>' +
                '</header>' +
                '<p class="p-comment-text">'+ msg.data.text +'</p>' +
            '</article>';

        if ("parent_comment" in msg.data){
            p.append(cmt);
        } else {
            p.before(cmt);
        }

        if (new_comment) {
            new_comment = false;
            location.hash = "";
            location.hash = "#article-comment-" + msg.data.id.toString();
        }
    });
    centrifuge.connect();
    return centrifuge;
}

var g_centrifuge = undefined;
var new_comment = false;

$(document).ready(function () {
    g_centrifuge = subscribe_to_new_answers();
});